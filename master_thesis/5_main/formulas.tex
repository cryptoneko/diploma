\section{Розв'язок}

\subsection{Бінарна функція витрат}

Розглянемо функцію витрат,
за якої вірним є лише один набір параметрів,
а за всі інші сплачується штраф $1$.

Вважаємо, що на даному зображенні $t$
присутній нормальний шум з невідомою дисперсією $\sigma^2_t$.
Тоді ймовірність того,
що дане зображення було отримано саме з параметрами $x$
\begin{equation*}
  \mathbb{P}_I\left( x \;\middle|\; t \right)
  = \prod_{i \in I}
    \frac{\exp{\left\{- \frac{\left( t_i - f_i\left( x \right) \right)^2}
           {2 \cdot \sigma^2_t} \right\}}}
           {\sqrt{2 \cdot \pi \cdot \sigma^2_t}}.
\end{equation*}
Коли з контексту буде зрозуміло,
якому саме зображенню належить дана дисперсія,
індекс $t$ не будемо використовувати.

Максимізуємо логарифм ймовірності,
тому що це зручніше,
ніж максимізація добутку кількох десятків тисяч або мільйонів значень
\begin{equation*}
  \ln{\mathbb{P}_I\left( x \mid t \right)}
  = \sum_{i \in I}
    \left\{
      - \frac{\left( t_i - f_i\left( x \right) \right)^2}{2 \cdot \sigma^2}
      - \frac{\ln{2} + \ln{\pi} + 2 \cdot \ln{\sigma}}{2}
    \right\}
  \to \max.
\end{equation*}
Позбуваємося константного доданку та помножимо на подвоєну ненульову дисперсію
\begin{equation*}
  \sum_{i \in I} \left( t_i - f_i\left( x \right) \right)^2 \to \min.
\end{equation*}
Бачимо,
що мінімізація суми квадратів різниць між дійсним та згенерованим зображенням
розв'язує задачу з бінарною функцією втрат
та гаусовим шумом на зображенні без інших додаткових умов,
які буде розглянуто далі.

Введемо множину пікселів $F \subset I$,
які на зображенні $f\left( x \right)$ належать обличчю.
Тоді суму можно розбити на дві
\begin{equation*}
  \sum_{i \in I} \left( t_i - f_i\left( x \right) \right)^2
  = \sum_{i \in F} \left( t_i - f_i\left( x \right) \right)^2
  + \sum_{i \in I \setminus F} \left( t_i - f_i\left( x \right) \right)^2.
\end{equation*}
Рахуємо вибірковую дисперсію для тієї частини зображення,
де зображено обличчя
\begin{equation*}
  \overline{\sigma_F^2}
  = \frac{\sum\limits_{i \in F} \left( t_i - f_i\left( x \right) \right)^2}
    {\left| F - 1 \right|}.
\end{equation*}
Екстраполюємо це значення на все зображення
\begin{equation*}
  \overline{\sigma_F^2}
  \approx \frac{\sum\limits_{i \in I}
             \left( t_i - f_i\left( x \right) \right)^2}
            {\left| I \right| - 1}.
\end{equation*}
Тоді вираз, який треба мінімізувати, можна представити як
\begin{equation*}
  \sum_{i \in I} \left( t_i - f_i\left( x \right) \right)^2
  \approx \left( \left| I \right| - 1 \right) \cdot \overline{\sigma_F^2}
  \to \min.
\end{equation*}
Оскільки розмір зображення фіксований і його зменшити не вийде,
потрібно зменшити вибіркову дисперсію на пікселях обличчя
\begin{equation*}
  \overline{\sigma_F^2}
  = \frac{\sum\limits_{i \in F} \left( t_i - f_i\left( x \right) \right)^2}
         {\left| F - 1 \right|}
  \to \min.
\end{equation*}

\subsection{Різниця параметрів з урахуванням їх гаусового розподілу}

Вважаємо, що на даному зображенні $t$
присутній нормальний шум з невідомою дисперсією $\sigma^2_t$.
Ймовірність того, що зображення моделі з конкретними параметрами $x$
є очищеним від шумів зображенням $t$
\begin{equation*}
  \mathbb{P}_I\left( x \mid t \right)
  = \prod_{i \in I}
    \frac{\exp{\left\{ - \frac{\left( t_i - f_i\left( x \right) \right)^2}
    {2 \cdot \sigma^2} \right\}}}{\sqrt{2 \cdot \pi \cdot \sigma^2}}.
\end{equation*}
Відомо, що параметри $x$ --- набори коефіцієнтів нормованих головних компонент,
тобто мають стандартний гаусовий розподіл.
Ймовірність того, что було згенеровано саме такий набір
\begin{equation*}
  \mathbb{P}_X\left( x \mid t \right)
  = \prod_{p \in P}
    \frac{\exp{\left( - \frac{x_p^2}{2} \right)}}{\sqrt{2 \cdot \pi}}.
\end{equation*}
Ймовірність того,
що дане зображення $t$ було отримано саме з параметрами $x$,
є добутком ймовірностей
\begin{equation*}
  \mathbb{P}\left( x \mid t \right)
  = \mathbb{P}_I\left( x \mid t \right)
    \cdot \mathbb{P}_X\left( x \mid t \right)
  = \prod_{i \in I}
    \frac{\exp{\left\{ - \frac{\left( t_i - f_i\left( x \right) \right)^2}
         {2 \cdot \sigma^2} \right\}}}{\sqrt{2 \cdot \pi \cdot \sigma^2}}
    \cdot
    \prod_{p \in P}
    \frac{\exp{\left( - \frac{x_p^2}{2} \right)}}{\sqrt{2 \cdot \pi}}.
\end{equation*}
Коли з контексту буде зрозуміло,
якому саме зображенню належить дана дисперсія,
індекс $t$ не будемо використовувати.

\begin{equation*}
  c = \left( 2 \cdot \pi \right)^{\frac{\left| I \right| + \left| P \right|}{2}}
      \cdot \sigma^{\left| I \right|}
\end{equation*}

\begin{equation*}
  \mathbb{P}\left( x \mid t \right)
  = c
    \cdot \exp{\left\{ - \frac{\left\| t - f\left( x \right) \right\|}
                              {2 \cdot \sigma^2} \right\}}
    \cdot \exp{\left\{ - \frac{\left\| x \right\|}{2} \right\}}
\end{equation*}

\begin{equation*}
  q^* \left( t \right)
  = c
    \cdot \sum_{x \in X}
      x
      \cdot \exp{\left\{ - \frac{\left\| x \right\|}{2} \right\}}
      \cdot \exp{\left\{ - \frac{\left\| t - f\left( x \right) \right\|}
                                {2 \cdot \sigma^2} \right\}}
\end{equation*}

\begin{equation*}
  \begin{split}
    \overline{\sigma^2}
      &= \sum_{x \in X} \frac{\left\| f\left( x \right) - t \right\|}{N}, \qquad
      N = \left| X \right| \cdot \left| I \right| - 1 \\
    D_t^2\left( x \right)
      &= \frac{\left\| f\left( x \right) - t \right\|}
              {2 \cdot \overline{\sigma^2}}
  \end{split}
\end{equation*}

\begin{equation*}
  q'\left( t \right)
  =
  c \cdot
  \sum_{x \in X}
  x
  \cdot \exp{\left\{
    - D_t^2\left( x \right)
    - \frac{\left\| x \right\|}{2} \right\}}
\end{equation*}

\begin{equation*}
  \begin{cases}
    \max\limits_{x} D_t^2\left( x \right) = 0, \\
    \min\limits_{x} D_t^2\left( x \right) < \infty,
  \end{cases} \forall t \in T
\end{equation*}

\begin{equation*}
  q'\left( t \right)
  \sim
  q''\left( t \right)
  =
  c \cdot
  \int\limits_{X}
    x
    \cdot \exp{\left\{
      - D_t^2\left( x \right)
      - \frac{\left\| x \right\|}{2} \right\}} \;dx, \qquad
  X = \mathbb{R}^{\left| P \right|}
\end{equation*}

\begin{equation*}
  q_i''\left( t \right)
  =
  c \cdot
  \int\limits_{\mathbb{R}} x_i \cdot e^{- \frac{x_i^2}{2}}
  \int\limits_{\mathbb{R}} e^{- \frac{x_1^2}{2}}
  \dots
  \int\limits_{\mathbb{R}} e^{- \frac{x_{i-1}^2}{2}}
  \int\limits_{\mathbb{R}} e^{- \frac{x_{i+1}^2}{2}}
  \dots
  \int\limits_{\mathbb{R}} e^{- \frac{x_p^2}{2}} e^{-D_t^2\left( x \right)}
  \;dx
\end{equation*}

\begin{equation*}
  \max_f{q''_i\left( t \right)}
  =
  c \cdot
  \int\limits_{\mathbb{R}} x_i \cdot e^{- \frac{x_i^2}{2}} \;dx_i
  \cdot
  \left(
    \int\limits_{\mathbb{R}} e^{- \frac{y^2}{2}} \;dy
  \right)^{\left| P \right| - 1}
\end{equation*}

\begin{equation*}
  c \cdot \left( \frac{\pi}{2} \right)^{\left| P \right|} = 1
  \Longrightarrow
  c = \left( \frac{\pi}{2} \right)^{- \frac{\left| P \right|}{2}}
\end{equation*}

\begin{equation*}
  \left| q''_i\left( t \right) \right|
  \le \left( \frac{\pi}{2} \right)^{- \frac{1}{2}}
\end{equation*}

\subsection{Monte-Carlo}

\begin{equation*}
  \begin{split}
    z^2_{\gamma} = 2.575^2 \\
    \varepsilon^2 = 0.01^2 \\
    M\left( N \right) = \sum_{i=1}^{N} \left(
        \hat{Q}^{\left( i \right)}\left( x \right)
      \right)^2 \\
      S\left( N \right) = \sum_{i=1}^{N} \left(
      \hat{Q}^{\left( i \right)}\left( x \right)
      \right) \\
    \hat{V}^2_r = \frac{1}{N-1}
      \cdot \left[ M\left( N \right) - \frac{1}{N}
        \cdot \left( S\left( N \right) \right) \right] \\
    \hat{Q}^2_N = \left( \frac{1}{N} \cdot S\left( N \right) \right)
  \end{split}
\end{equation*}
